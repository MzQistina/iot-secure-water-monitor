# Production docker-compose configuration
# Use this when deploying to the same server as MySQL

# To use this file:
# docker-compose -f docker-compose.production.yml up -d

services:
  # Flask Web Application Service
  # For production: Deploy on same server as MySQL, use localhost
  web:
    build: .
    container_name: water_monitor_web
    restart: always
    ports:
      - "${FLASK_PORT:-5000}:5000"
    environment:
      # Database connection (localhost - same server as MySQL)
      DB_HOST: localhost
      DB_PORT: 3306
      DB_USER: ${DB_USER:-ilmuwanutara_e2eewater}
      DB_PASSWORD: ${DB_PASSWORD:-e2eeWater@2025}
      DB_NAME: ${DB_NAME:-ilmuwanutara_e2eewater}
      DB_TYPE: mysql
      # Flask configuration
      FLASK_HOST: 0.0.0.0
      FLASK_RUN_PORT: 5000
      PORT: 5000
      FLASK_ENV: ${FLASK_ENV:-production}
      FLASK_DEBUG: ${FLASK_DEBUG:-0}
      PYTHONUNBUFFERED: 1
    volumes:
      # Mount keys directory for persistence
      - ./keys:/app/keys
      - ./user_keys:/app/user_keys
      - ./sensor_keys:/app/sensor_keys
    # Use host network mode for same-server deployment (Linux)
    # This allows Docker to use localhost to connect to MySQL on the same server
    network_mode: "host"
    # Alternative (if host network doesn't work): Use extra_hosts
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"

