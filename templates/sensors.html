<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensors - Water Monitoring</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script>
        // Apply theme immediately before page renders to prevent white flash
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-primary); margin: 0; color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; min-height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 1100px; margin: 30px auto; background: var(--bg-secondary); border-radius: 12px; box-shadow: var(--shadow-lg); padding: 24px; transition: background-color 0.3s ease, box-shadow 0.3s ease; flex: 1; margin-bottom: 120px; }
        h1 { color: var(--text-primary); margin: 0 0 10px; transition: color 0.3s ease; }
        .subtitle { color: var(--text-secondary); margin-bottom: 18px; transition: color 0.3s ease; }
        .toolbar { display:flex; justify-content: space-between; align-items:center; margin-bottom: 12px; gap:10px; flex-wrap:wrap; }
        .btn { background:#2a4d69; color:#fff; border:none; padding: 10px 14px; border-radius:8px; cursor:pointer; text-decoration:none; display:inline-block; font-size: 0.95rem; font-weight: 500; transition: background 0.2s ease; pointer-events: auto; position: relative; z-index: 1; }
        .btn:hover { background:#1e3b52; }
        .btn:active { transform: scale(0.98); }
        .btn:focus { outline: 2px solid #2a4d69; outline-offset: 2px; }
        .filters { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
        .filters form { flex: 1; min-width: 0; }
        .filters input, .filters select { padding:8px 10px; border:1px solid var(--border-input); border-radius:8px; background: var(--bg-secondary); color: var(--text-primary); transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; flex: 1; min-width: 150px; }
        .filters button[type="submit"] { flex-shrink: 0; white-space: nowrap; }
        .table-wrap { overflow:auto; border:1px solid var(--border-color); border-radius:10px; transition: border-color 0.3s ease; }
        table { width: 100%; border-collapse: collapse; min-width:960px; }
        th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid var(--border-light); color: var(--text-primary); transition: border-color 0.3s ease, color 0.3s ease; }
        thead th { position: sticky; top: 0; z-index: 1; }
        th { color: var(--text-primary); font-weight:700; background: var(--bg-tertiary); transition: background-color 0.3s ease, color 0.3s ease; }
        tbody tr:nth-child(4n+1), tbody tr:nth-child(4n+2) { background: var(--bg-secondary); }
        tbody tr:nth-child(4n+3), tbody tr:nth-child(4n+4) { background: var(--bg-secondary); }
        tbody tr:hover { background: var(--bg-tertiary); transition: background-color 0.3s ease; }
        .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 0.85rem; font-weight: 700; }
        .pill.active { background:#d4f5e9; color:#217a4d; border:1px solid #b2e6d2; }
        .pill.inactive { background:#ffecc7; color:#8a5a00; border:1px solid #ffd591; }
        .empty { color: var(--text-secondary); background: var(--bg-tertiary); border:1px dashed var(--border-color); padding: 18px; border-radius: 8px; text-align:center; margin-top: 12px; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .nowrap { white-space: nowrap; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
        .actions { text-align:right; }
        /* Modal styles */
        .modal { position: fixed; inset: 0; display:none; align-items: center; justify-content: center; background: rgba(0,0,0,0.35); padding: 0; z-index: 10000; }
        .modal.open { display:flex; }
        .modal-card { width: 100%; max-width: 640px; background: var(--bg-secondary); border-radius:12px; box-shadow: var(--shadow-lg); margin: 16px; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .modal-header { padding:10px 12px; border-bottom:1px solid var(--border-color); display:flex; justify-content: space-between; align-items:center; transition: border-color 0.3s ease; }
        .modal-title { margin:0; color: var(--text-primary); transition: color 0.3s ease; }
        .modal-body { padding:12px; }
        .modal-actions { padding:10px 12px; border-top:1px solid var(--border-color); display:flex; gap:8px; align-items:center; justify-content:flex-end; transition: border-color 0.3s ease; }
        body.modal-open { overflow: hidden; }
        /* Form control normalization inside modal */
        .modal-body label { display:block; font-weight:600; color: var(--text-primary); margin-bottom:4px; transition: color 0.3s ease; }
        .modal-body input[type="text"], .modal-body select, .modal-body textarea {
            width:100%; padding:8px 9px; border:1px solid var(--border-input); border-radius:8px; box-sizing: border-box; font-size:0.95rem; background: var(--bg-secondary); color: var(--text-primary); transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .modal-body textarea { min-height: 90px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
        @media (max-width: 860px){
            .modal-body .grid-2 { grid-template-columns: 1fr; }
        }
        @media (max-width: 900px) {
            .container {
                margin: 16px auto;
                padding: 20px 16px;
            }
            .toolbar {
                flex-direction: column;
                align-items: flex-start;
            }
            .filters {
                width: 100%;
                flex-wrap: wrap;
            }
            .filters form {
                width: 100%;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }
            .filters input, .filters select {
                flex: 1;
                min-width: 150px;
                font-size: 16px; /* Prevents zoom on iOS */
                height: 44px; /* Better touch target */
            }
            .filters button[type="submit"] {
                min-width: 80px;
                height: 44px;
            }
            .btn {
                padding: 12px 16px;
                min-height: 44px;
                font-size: 1rem;
            }
            h1 {
                font-size: 1.4rem;
            }
            .subtitle {
                font-size: 0.9rem;
            }
        }
        @media (max-width: 600px) {
            .container {
                margin: 12px;
                padding: 16px;
            }
            .table-wrap {
                -webkit-overflow-scrolling: touch;
            }
            table {
                min-width: 800px;
            }
            th, td {
                padding: 8px 6px;
                font-size: 0.85rem;
            }
            .modal-card {
                margin: 12px;
            }
            .modal-body input[type="text"], 
            .modal-body select, 
            .modal-body textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
            }
        }
        /* Flash Message Styles */
        .flash { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid transparent; font-weight: 500; display: flex; align-items: center; }
    </style>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self';">
</head>
<body>
    {% include 'sidebar.html' %}
    {% from 'success_alert.html' import success_alert %}
    {% from 'error_alert.html' import error_alert %}
    {% include 'success_alert.html' %}
    {% include 'error_alert.html' %}
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, msg in messages %}
                {% if category == 'success' %}
                    {{ success_alert(msg) }}
                {% elif category == 'error' %}
                    {{ error_alert(msg) }}
                {% else %}
                    <div class="flash {{ category }}" style="margin-bottom:12px; padding:10px 12px; border-radius:8px; border:1px solid;">
                        {{ msg }}
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        {% endwith %}
        <div class="toolbar">
            <div>
                <h1>Sensors</h1>
                <div class="subtitle">Registered IoT devices and key metadata</div>
            </div>
            <div class="filters">
                <form method="get" action="{{ url_for('sensors') }}" id="filter-form" style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
                    <input type="text" name="q" value="{{ q or '' }}" placeholder="Search device, type, location..." id="search-input">
                    <select name="status" id="status-select">
                        <option value="">All statuses</option>
                        <option value="active" {% if status_filter=='active' %}selected{% endif %}>active</option>
                        <option value="inactive" {% if status_filter=='inactive' %}selected{% endif %}>inactive</option>
                    </select>
                    <button class="btn" type="submit" id="filter-btn">Filter</button>
                </form>
                <a class="btn" href="{{ url_for('sensors_register') }}">Register New Sensor</a>
            </div>
        </div>

        <div style="margin: 6px 0 16px; padding:10px 12px; border-radius:8px; background:#fff7e6; border:1px solid #ffe3b3; color:#8a5a00; font-weight:600;">
            Note: It is recommended to have at most 3 devices active at a time per user for optimal performance. You can activate or deactivate devices using the Edit button.
        </div>

        {% if sensors and sensors|length > 0 %}
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>Type</th>
                        <th>Location</th>
                        <th class="nowrap">Threshold</th>
                        <th>Status</th>
                        <th class="nowrap">Key Updated</th>
                        <th class="nowrap">Last Updated</th>
                        <th class="actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in sensors %}
                    <tr>
                        <td class="mono">{{ s.device_id }}</td>
                        <td>{{ s.device_type }}</td>
                        <td>{{ s.location or '-' }}</td>
                        <td class="nowrap">
                            {% set minv = s.min_threshold_effective %}
                            {% set maxv = s.max_threshold_effective %}
                            {% if minv is none and maxv is none %}
                                -
                            {% else %}
                                {{ minv if minv is not none else '-' }} â€“ {{ maxv if maxv is not none else '-' }}
                                {% if s.threshold_source == 'custom' %}
                                    <span class="pill" style="background:#eef6ff; color:#1d4ed8; border:1px solid #bfdbfe;">custom</span>
                                {% elif s.threshold_source == 'default' %}
                                    <span class="pill" style="background:#f1f5f9; color:#0f172a; border:1px solid #e2e8f0;">default</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            <span class="pill {{ s.status }}">{{ s.status }}</span>
                        </td>
                        <td class="nowrap" style="font-size: 0.9em;">
                            {% if s.key_updated_at %}
                                {{ s.key_updated_at }}
                            {% else %}
                                <span style="color: #999;">Never</span>
                            {% endif %}
                        </td>
                        <td class="nowrap" style="font-size: 0.9em;">{{ s.updated_at or s.registered_at or '-' }}</td>
                        
                        <td class="actions">
                            <div style="display:flex; gap:8px; justify-content:flex-end;">
                                <button class="btn" type="button" onclick="openEditModal(this)" data-device_id="{{ s.device_id }}" data-device_type="{{ s.device_type }}" data-location="{{ s.location or '' }}" data-status="{{ s.status }}" data-key-updated="{{ s.key_updated_at or '' }}" data-has-key="{{ '1' if s.has_key else '0' }}" data-fingerprint="{{ s.public_key_fingerprint or '' }}" data-def-min="{{ s.default_min or '' }}" data-def-max="{{ s.default_max or '' }}" data-custom-min="{{ s.min_threshold or '' }}" data-custom-max="{{ s.max_threshold or '' }}">Edit</button>
                                <form method="post" action="{{ url_for('sensors_delete') }}" onsubmit="event.preventDefault(); handleDeleteSensor('{{ s.device_id }}', this);">
                                    <input type="hidden" name="device_id" value="{{ s.device_id }}">
                                    <button type="submit" class="btn" style="background:#b02a37;">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    <!-- edit modal trigger values stored on button via data-* attributes above -->
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <div class="empty">No sensors registered yet. Click "Register New Sensor" to add one.</div>
        {% endif %}
    </div>
    <!-- Edit Modal -->
    <div id="editModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="modal-card">
            <div class="modal-header">
                <h3 class="modal-title">Edit Sensor <span class="mono" data-field="device_id"></span></h3>
                <button class="btn" type="button" onclick="closeEditModal()" style="background:#6c757d;">Close</button>
            </div>
            <form method="post" action="{{ url_for('sensors_update') }}">
                <div class="modal-body">
                    <div class="subtitle" style="margin:0 0 12px; color: var(--text-secondary);">Type: <strong data-field="device_type" style="color: var(--text-primary);"></strong></div>
                    <input type="hidden" name="device_id" value="">
                        <div class="grid-2" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:start;">
                        <div>
                            <label>Location</label>
                            <input type="text" name="location">
                        </div>
                        <div>
                            <label>Status</label>
                            <select name="status">
                                <option value="active">active</option>
                                <option value="inactive">inactive</option>
                            </select>
                        </div>
                        
                        <div style="grid-column: span 2;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <label style="margin:0;">Public Key Management</label>
                                <button type="button" id="edit_provision_btn" class="btn" style="padding:8px 14px; white-space:nowrap; font-size:0.9rem;">Update/Regenerate Key</button>
                            </div>
                            <div style="padding:8px; border:1px dashed var(--border-input); border-radius:8px; background: var(--bg-tertiary); color: var(--text-primary); font-size:0.9em;">
                                <div style="margin-bottom:4px;">Key Status: <span id="key-status-indicator" style="font-weight:600;">Checking...</span></div>
                                <div style="margin-bottom:4px; font-family: monospace; font-size:0.85em;">
                                    Fingerprint: <span id="key-fingerprint" style="font-weight:600;">-</span>
                                </div>
                                <div style="color: var(--text-secondary); font-size:0.85em;">
                                    Last updated: <span id="key-updated-time">-</span>
                                </div>
                            </div>
                            <div id="edit_provision_status" style="color:#355972; font-size:0.9rem; margin-top:6px;"></div>
                        </div>
                        <div style="grid-column: span 2; background: var(--bg-tertiary); padding:10px; border-radius:8px;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:end;">
                                <div>
                                    <label style="margin:0; display:flex; align-items:center; gap:8px; font-weight:600; color: var(--text-primary);">
                                        <input type="checkbox" id="use_default_cb" checked onchange="toggleDefault(this)">
                                        <input type="hidden" name="use_default_cb" id="use_default_cb_hidden" value="1">
                                        <span>Use default threshold</span>
                                    </label>
                                </div>
                                <div style="text-align:right; color: var(--text-secondary); font-size:0.92rem;">
                                    Default: <span data-field="default_min">-</span> to <span data-field="default_max">-</span>
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; color: var(--text-primary);">Min</label>
                                    <input type="text" name="min_threshold" placeholder="e.g., 6.5" style="max-width:200px; width:100%;" disabled>
                                </div>
                                <div>
                                    <label style="display:block; font-weight:600; color: var(--text-primary);">Max</label>
                                    <input type="text" name="max_threshold" placeholder="e.g., 8.5" style="max-width:200px; width:100%;" disabled>
                                </div>
                            </div>
                        </div>
                        <div style="grid-column: span 2;">
                            <label>Public Key (PEM, required if setting active)</label>
                            <textarea name="public_key" placeholder="-----BEGIN PUBLIC KEY-----
...
-----END PUBLIC KEY-----" rows="4" style="min-height: 70px;"></textarea>
                            <div style="color: var(--text-secondary); margin-top:6px;">Leave blank to keep existing. Required only when activating.</div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" style="background:#6c757d;" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Ensure filter form works properly
        document.addEventListener('DOMContentLoaded', function() {
            var filterForm = document.getElementById('filter-form');
            var filterBtn = document.getElementById('filter-btn');
            
            if (filterForm && filterBtn) {
                // Ensure button click submits form
                filterBtn.addEventListener('click', function(e) {
                    // Don't prevent default - let form submit naturally
                    console.log('Filter button clicked');
                });
                
                // Also allow Enter key to submit
                var searchInput = document.getElementById('search-input');
                var statusSelect = document.getElementById('status-select');
                
                if (searchInput) {
                    searchInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            filterForm.submit();
                        }
                    });
                }
                
                if (statusSelect) {
                    statusSelect.addEventListener('change', function() {
                        // Optional: Auto-submit on status change
                        // Uncomment the line below if you want auto-submit
                        // filterForm.submit();
                    });
                }
            }
        });
        
        function openEditModal(btn){
            var modal = document.getElementById('editModal');
            if (!modal) return;
            // Populate form
            modal.querySelector('input[name="device_id"]').value = btn.getAttribute('data-device_id') || '';
            modal.querySelector('[data-field="device_id"]').textContent = btn.getAttribute('data-device_id') || '';
            modal.querySelector('[data-field="device_type"]').textContent = btn.getAttribute('data-device_type') || '';
            modal.querySelector('input[name="location"]').value = btn.getAttribute('data-location') || '';
            
            var status = btn.getAttribute('data-status') || '';
            var sel = modal.querySelector('select[name="status"]');
            if (sel){ sel.value = status; }
            // Clear public key textarea by default
            var pk = modal.querySelector('textarea[name="public_key"]');
            if (pk){ pk.value = ''; }
            // Key status, fingerprint, and timestamp
            var keyUpdated = btn.getAttribute('data-key-updated') || '';
            var hasKey = btn.getAttribute('data-has-key') === '1';
            var fingerprint = btn.getAttribute('data-fingerprint') || '';
            var keyStatusEl = document.getElementById('key-status-indicator');
            var keyFingerprintEl = document.getElementById('key-fingerprint');
            var keyTimeEl = document.getElementById('key-updated-time');
            
            if (keyStatusEl) {
                // Check if key exists (either has key_updated_at timestamp OR has_key flag)
                if (hasKey || keyUpdated) {
                    keyStatusEl.textContent = 'Key configured';
                    keyStatusEl.style.color = '#22c55e'; // green
                } else {
                    keyStatusEl.textContent = 'No key set';
                    keyStatusEl.style.color = '#999';
                }
            }
            
            if (keyFingerprintEl) {
                if (fingerprint) {
                    keyFingerprintEl.textContent = fingerprint;
                    keyFingerprintEl.style.color = '#2a4d69';
                } else {
                    keyFingerprintEl.textContent = 'No key';
                    keyFingerprintEl.style.color = '#999';
                }
            }
            
            if (keyTimeEl) {
                // Show key_updated_at if available, otherwise show message for legacy keys
                if (keyUpdated) {
                    keyTimeEl.textContent = keyUpdated;
                } else if (hasKey) {
                    keyTimeEl.textContent = 'Before tracking (legacy)';
                    keyTimeEl.style.color = '#666';
                } else {
                    keyTimeEl.textContent = 'Never';
                }
            }

            // Fill default min/max from data attributes
            var defMin = btn.getAttribute('data-def-min') || '';
            var defMax = btn.getAttribute('data-def-max') || '';
            var defMinEl = modal.querySelector('[data-field="default_min"]');
            var defMaxEl = modal.querySelector('[data-field="default_max"]');
            if (defMinEl) defMinEl.textContent = defMin || '-';
            if (defMaxEl) defMaxEl.textContent = defMax || '-';

            // Initialize default toggle and custom values
            var cb = modal.querySelector('#use_default_cb');
            var minInput = modal.querySelector('input[name="min_threshold"]');
            var maxInput = modal.querySelector('input[name="max_threshold"]');
            var customMin = btn.getAttribute('data-custom-min') || '';
            var customMax = btn.getAttribute('data-custom-max') || '';
            var hadCustom = (customMin && customMin !== '') || (customMax && customMax !== '');
            if (cb){ cb.checked = !hadCustom; }
            if (hadCustom){
                if (minInput) minInput.value = customMin;
                if (maxInput) maxInput.value = customMax;
            }
            toggleDefault(cb);

            // Update PK requirement based on status and whether a key exists
            setPublicKeyRequirement(modal);

            // Re-evaluate when status changes
            if (sel){
                sel.onchange = function(){ setPublicKeyRequirement(modal); };
            }

            // Setup provision button handler
            var provisionBtn = document.getElementById('edit_provision_btn');
            var provisionStatus = document.getElementById('edit_provision_status');
            var currentDeviceId = btn.getAttribute('data-device_id') || '';
            
            // Reset provision button and status when modal opens
            if (provisionBtn){
                provisionBtn.disabled = false;
                provisionBtn.textContent = 'Update/Regenerate Key';
                provisionBtn.style.opacity = '1';
                provisionBtn.style.cursor = 'pointer';
            }
            if (provisionStatus){
                provisionStatus.textContent = '';
            }
            
            if (provisionBtn){
                provisionBtn.onclick = function(){
                    if (!currentDeviceId || currentDeviceId.trim() === ''){
                        alert('Device ID is required');
                        return;
                    }
                    
                    // Update button state
                    provisionBtn.disabled = true;
                    provisionBtn.textContent = 'Updating...';
                    provisionBtn.style.opacity = '0.7';
                    provisionBtn.style.cursor = 'not-allowed';
                    
                    if (provisionStatus){
                        provisionStatus.textContent = 'Regenerating keys on Raspberry Pi...';
                        provisionStatus.style.color = '#355972';
                    }
                    
                    // Fire a provision UPDATE request to the device via MQTT (regenerate keys)
                    // This sends to topic: provision/{device_id}/update (NOT request)
                    var provisionUrl = "{{ url_for('api_provision_update') }}";
                    console.log('Sending provision UPDATE to:', provisionUrl, 'for device:', currentDeviceId);
                    fetch(provisionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device_id: currentDeviceId })
                    }).then(function(response) {
                        if (!response.ok) {
                            // Try to parse error message from response
                            return response.json().then(function(errorData) {
                                console.error('Server error response:', errorData);
                                
                                // Build error message - prefer error field, fallback to details
                                var errorMsg = errorData.error || errorData.details || 'Request failed: ' + response.status;
                                
                                // Add hint if available (don't duplicate if already in error message)
                                if (errorData.hint && !errorMsg.includes(errorData.hint)) {
                                    errorMsg += '\n\nðŸ’¡ ' + errorData.hint;
                                }
                                
                                // Add details if different from error message
                                if (errorData.details && errorData.details !== errorData.error && !errorMsg.includes(errorData.details)) {
                                    errorMsg += '\n\nDetails: ' + errorData.details;
                                }
                                
                                throw new Error(errorMsg);
                            }).catch(function(parseErr) {
                                // If JSON parsing fails, use status code
                                console.error('Failed to parse error response:', parseErr);
                                throw new Error('Request failed: ' + response.status);
                            });
                        }
                        return response.json();
                    }).then(function(data) {
                        if (provisionStatus) {
                            provisionStatus.textContent = 'âœ… Key regeneration request sent. Waiting for Raspberry Pi to upload new key...';
                            provisionStatus.style.color = '#1e6b3a';
                        }
                        
                        // Store initial timestamp and fingerprint for comparison
                        var keyTimeEl = document.getElementById('key-updated-time');
                        var keyFingerprintEl = document.getElementById('key-fingerprint');
                        var initialTimestamp = keyTimeEl ? keyTimeEl.textContent.trim() : 'Never';
                        var initialFingerprint = keyFingerprintEl ? keyFingerprintEl.textContent.trim() : '';
                        var checkCount = 0;
                        var maxChecks = 30; // Check for up to 60 seconds (30 checks * 2 seconds)
                        
                        // Poll for key update
                        var checkInterval = setInterval(function(){
                            checkCount++;
                            fetch("{{ url_for('api_sensor_key_timestamp') }}?device_id=" + encodeURIComponent(currentDeviceId), { cache: 'no-store' })
                                .then(res => {
                                    if (!res.ok) return null;
                                    return res.json();
                                })
                                .then(data => {
                                    if (!data) return;
                                    
                                    var keyTimeEl = document.getElementById('key-updated-time');
                                    var keyStatusEl = document.getElementById('key-status-indicator');
                                    var keyFingerprintEl = document.getElementById('key-fingerprint');
                                    var newTimestamp = data.key_updated_at || null;
                                    var hasKey = data.has_key || false;
                                    var newFingerprint = data.fingerprint || null;
                                    
                                    // Check if timestamp or fingerprint changed (key was updated)
                                    var timestampChanged = false;
                                    var fingerprintChanged = false;
                                    
                                    if (newTimestamp) {
                                        // Normalize timestamps for comparison (remove extra spaces, handle different formats)
                                        var normalizedNew = newTimestamp.trim();
                                        var normalizedInitial = initialTimestamp.trim();
                                        
                                        // Check if timestamp actually changed
                                        if (normalizedNew !== normalizedInitial && 
                                            normalizedInitial !== 'Never' && 
                                            normalizedInitial !== '-' &&
                                            normalizedInitial !== 'Before tracking (legacy)') {
                                            timestampChanged = true;
                                        } else if (normalizedInitial === 'Never' && normalizedNew) {
                                            // Went from "Never" to having a timestamp
                                            timestampChanged = true;
                                        }
                                    }
                                    
                                    // Check if fingerprint changed
                                    if (newFingerprint && newFingerprint !== initialFingerprint && initialFingerprint !== 'No key' && initialFingerprint !== '-') {
                                        fingerprintChanged = true;
                                    } else if (newFingerprint && (initialFingerprint === 'No key' || initialFingerprint === '-')) {
                                        // Went from "No key" to having a fingerprint
                                        fingerprintChanged = true;
                                    }
                                    
                                    if (timestampChanged || fingerprintChanged) {
                                        // Key was updated!
                                        clearInterval(checkInterval);
                                        
                                        // Update UI
                                        if (keyTimeEl && newTimestamp) {
                                            keyTimeEl.textContent = newTimestamp;
                                            keyTimeEl.style.color = '';
                                        }
                                        if (keyStatusEl) {
                                            keyStatusEl.textContent = 'Key configured';
                                            keyStatusEl.style.color = '#22c55e';
                                        }
                                        if (keyFingerprintEl && newFingerprint) {
                                            keyFingerprintEl.textContent = newFingerprint;
                                            keyFingerprintEl.style.color = '#2a4d69';
                                        }
                                        if (provisionStatus) {
                                            var updateMsg = 'âœ… Key successfully regenerated and uploaded!';
                                            if (fingerprintChanged && timestampChanged) {
                                                updateMsg += ' Fingerprint and timestamp updated.';
                                            } else if (fingerprintChanged) {
                                                updateMsg += ' Fingerprint updated.';
                                            } else if (timestampChanged) {
                                                updateMsg += ' Timestamp updated.';
                                            }
                                            provisionStatus.textContent = updateMsg;
                                            provisionStatus.style.color = '#1e6b3a';
                                        }
                                    } else if (hasKey && (initialTimestamp === 'Never' || initialTimestamp === '-')) {
                                        // Key exists but no timestamp (legacy key) - update status
                                        if (keyStatusEl && keyStatusEl.textContent !== 'Key configured') {
                                            keyStatusEl.textContent = 'Key configured';
                                            keyStatusEl.style.color = '#22c55e';
                                        }
                                        if (keyTimeEl && keyTimeEl.textContent === 'Never') {
                                            keyTimeEl.textContent = 'Before tracking (legacy)';
                                            keyTimeEl.style.color = '#666';
                                        }
                                    }
                                    
                                    // Stop checking after max attempts
                                    if (checkCount >= maxChecks) {
                                        clearInterval(checkInterval);
                                        if (provisionStatus && keyTimeEl && keyTimeEl.textContent === initialTimestamp) {
                                            provisionStatus.textContent = 'â±ï¸ Still waiting for key upload. Check Raspberry Pi connection or refresh page manually.';
                                            provisionStatus.style.color = '#856404';
                                        }
                                    }
                                })
                                .catch(e => {
                                    console.error('Key timestamp check error:', e);
                                    // Continue checking on error
                                });
                        }, 2000); // Check every 2 seconds
                    }).catch(function(e){
                        console.error('Provision request error:', e);
                        if (provisionStatus) {
                            // Display error message (may contain newlines for hints)
                            var errorText = 'âŒ Error requesting key: ' + e.message;
                            // Replace newlines with spaces for single-line display, or use a more structured display
                            errorText = errorText.replace(/\n\n/g, ' | ').replace(/\n/g, ' ');
                            provisionStatus.textContent = errorText;
                            provisionStatus.style.color = '#b02a37';
                            // If message is long, show in a tooltip or expandable area
                            if (e.message.length > 100) {
                                provisionStatus.title = e.message; // Tooltip with full message
                            }
                        }
                    }).finally(function(){
                        // Re-enable button after a delay
                        setTimeout(function(){
                            if (provisionBtn){
                                provisionBtn.disabled = false;
                                provisionBtn.textContent = 'Update/Regenerate Key';
                                provisionBtn.style.opacity = '1';
                                provisionBtn.style.cursor = 'pointer';
                            }
                        }, 2000);
                    });
                };
            }

            // Validate on submit: require PK if activating and no existing key
            var form = modal.querySelector('form');
            if (form){
                form.onsubmit = function(e){
                    var requiredNow = setPublicKeyRequirement(modal);
                    var pkArea = modal.querySelector('textarea[name="public_key"]');
                    if (requiredNow && pkArea && (!pkArea.value || pkArea.value.trim() === '')){
                        e.preventDefault();
                        alert('Public key is required when setting status to active.');
                        pkArea.focus();
                        return false;
                    }
                    
                    // Enable threshold fields before submit so their values are sent
                    // (disabled fields don't submit their values)
                    var useDefaultCb = modal.querySelector('#use_default_cb');
                    var minInput = modal.querySelector('input[name="min_threshold"]');
                    var maxInput = modal.querySelector('input[name="max_threshold"]');
                    if (useDefaultCb && !useDefaultCb.checked) {
                        // User wants custom thresholds - enable fields so values are submitted
                        if (minInput) minInput.disabled = false;
                        if (maxInput) maxInput.disabled = false;
                    }
                };
            }
            modal.classList.add('open');
            document.body.classList.add('modal-open');
        }
        function closeEditModal(){
            var modal = document.getElementById('editModal');
            if (!modal) return;
            modal.classList.remove('open');
            document.body.classList.remove('modal-open');
        }

        // Helper toggles the required attribute for the PK textarea.
        // Returns true if PK is required, false otherwise.
        function setPublicKeyRequirement(modal){
            var sel = modal.querySelector('select[name="status"]');
            var pkArea = modal.querySelector('textarea[name="public_key"]');
            // Check if key exists by looking at key status indicator
            var keyStatusEl = document.getElementById('key-status-indicator');
            var hasExistingKey = keyStatusEl && keyStatusEl.textContent === 'Key configured';
            var isActive = sel && sel.value === 'active';
            var requirePk = isActive && !hasExistingKey;
            if (pkArea){ pkArea.required = requirePk; pkArea.style.borderColor = requirePk ? '#dc3545' : '#cfd9e3'; }
            return requirePk;
        }
        function toggleDefault(cb){
            var modal = document.getElementById('editModal');
            if (!modal) return;
            var minInput = modal.querySelector('input[name="min_threshold"]');
            var maxInput = modal.querySelector('input[name="max_threshold"]');
            var hiddenInput = document.getElementById('use_default_cb_hidden');
            var useDefault = cb && cb.checked;
            if (minInput) { minInput.disabled = useDefault; if (useDefault) minInput.value = ''; }
            if (maxInput) { maxInput.disabled = useDefault; if (useDefault) maxInput.value = ''; }
            // Update hidden input to track checkbox state (so it's submitted even when fields are disabled)
            if (hiddenInput) { hiddenInput.value = useDefault ? '1' : '0'; }
        }
        async function confirmDelete(deviceId){
            if (typeof showConfirmation === 'undefined') {
                // Fallback to browser confirm if dialog not loaded
                return confirm('Are you sure you want to delete sensor "' + deviceId + '"? This action cannot be undone.');
            }
            var confirmed = await showConfirmation(
                'Delete Sensor',
                'Are you sure you want to delete sensor "' + deviceId + '"? This action cannot be undone.',
                'Delete',
                'Cancel'
            );
            return confirmed;
        }
        
        async function handleDeleteSensor(deviceId, formElement) {
            var confirmed = await confirmDelete(deviceId);
            if (confirmed && formElement) {
                formElement.submit();
            }
        }
        
        // Function to check if provisioned key is available and auto-fill
        // Returns true if key was found, false otherwise
        function checkEditKeyStatus(deviceId, modal){
            if (!deviceId || !modal) return false;
            
            var provisionStatus = document.getElementById('edit_provision_status');
            var pkTextarea = modal.querySelector('textarea[name="public_key"]');
            var keyFound = false;
            
            fetch("{{ url_for('api_key_upload_status') }}?device_id=" + encodeURIComponent(deviceId), { cache: 'no-store' })
                .then(res => {
                    if (!res.ok) return null;
                    return res.json();
                })
                .then(sj => {
                    if (sj && sj.received){
                        // Key is available, fetch it
                        fetch("{{ url_for('api_key_upload_fetch') }}?device_id=" + encodeURIComponent(deviceId), { cache: 'no-store' })
                            .then(res => {
                                if (!res.ok) return null;
                                return res.json();
                            })
                            .then(fj => {
                                var pk = (fj && fj.public_key) || '';
                                if (pk && pkTextarea){
                                    pkTextarea.value = pk;
                                    keyFound = true;
                                    if (provisionStatus) {
                                        provisionStatus.textContent = 'âœ… Key received and auto-filled! You can now save changes.';
                                        provisionStatus.style.color = '#1e6b3a';
                                    }
                                }
                            })
                            .catch(e => { 
                                console.error('Key fetch error:', e);
                            });
                    }
                })
                .catch(e => { 
                    console.error('Key status check error:', e);
                });
            
            return keyFound;
        }
        
        // Auto-start tour for first-time users after registration
        (function() {
            var urlParams = new URLSearchParams(window.location.search);
            var tourParam = urlParams.get('tour');
            if (tourParam === 'first_sensor') {
                // Remove tour parameter from URL
                if (window.history.replaceState) {
                    var newUrl = window.location.pathname + (window.location.search.replace(/[?&]tour=first_sensor/, '').replace(/^&/, '?').replace(/^$/, ''));
                    window.history.replaceState({}, '', newUrl);
                }
                // Wait for page to fully load, then start tour
                setTimeout(function() {
                    if (typeof startTour === 'function') {
                        startTour();
                    } else {
                        // Wait for tour function to be available
                        var checkTour = setInterval(function() {
                            if (typeof startTour === 'function') {
                                clearInterval(checkTour);
                                startTour();
                            }
                        }, 100);
                        // Stop checking after 5 seconds
                        setTimeout(function() { clearInterval(checkTour); }, 5000);
                    }
                }, 800);
            }
        })();
    </script>
    {% include 'footer.html' ignore missing %}
</body>
</html>



