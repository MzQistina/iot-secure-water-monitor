# Note: version is obsolete in newer Docker Compose, but kept for compatibility

services:
  # Flask Web Application Service
  # Connects to MariaDB/MySQL database at ilmuwanutara.my
  # Note: Database is MariaDB 10.3.39 on the server
  web:
    build: .
    container_name: water_monitor_web
    restart: always
    ports:
      - "${FLASK_PORT:-5000}:5000"
    environment:
      # Database connection (MariaDB at ilmuwanutara.my)
      # If using SSH tunnel, set DB_HOST to host.docker.internal
      # If connecting directly, use ilmuwanutara.my (requires remote access granted)
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_PORT: ${DB_PORT:-3306}
      DB_USER: ${DB_USER:-ilmuwanutara_e2eewater}
      DB_PASSWORD: ${DB_PASSWORD:-e2eeWater@2025}
      DB_NAME: ${DB_NAME:-ilmuwanutara_e2eewater}
      DB_TYPE: mysql
      # Flask configuration
      FLASK_HOST: 0.0.0.0
      FLASK_RUN_PORT: 5000
      PORT: 5000
      FLASK_ENV: ${FLASK_ENV:-production}
      FLASK_DEBUG: ${FLASK_DEBUG:-0}
      PYTHONUNBUFFERED: 1
      # Security
      SECRET_KEY: ${SECRET_KEY:-dev-secret-change-me-in-production}
      # MQTT Configuration
      MQTT_HOST: ${MQTT_HOST:-192.168.43.214}
      MQTT_PORT: ${MQTT_PORT:-8883}
      MQTT_USER: ${MQTT_USER:-admin_flask}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-flaske2ee25}
      MQTT_USE_TLS: ${MQTT_USE_TLS:-true}
      MQTT_TLS_INSECURE: ${MQTT_TLS_INSECURE:-true}
      # Optional: MQTT certificate paths (if using client certificates)
      # MQTT_CA_CERTS: ${MQTT_CA_CERTS:-}
      # MQTT_CERTFILE: ${MQTT_CERTFILE:-}
      # MQTT_KEYFILE: ${MQTT_KEYFILE:-}
      # Database encryption (optional - uses db_encryption.key file if not set)
      # DB_ENCRYPTION_KEY: ${DB_ENCRYPTION_KEY:-}
      # Admin user (optional)
      # ADMIN_USERNAME: ${ADMIN_USERNAME:-}
      # ADMIN_PASSWORD: ${ADMIN_PASSWORD:-}
      # Device session settings (optional)
      # REQUIRE_DEVICE_SESSION: ${REQUIRE_DEVICE_SESSION:-false}
      # DEVICE_SESSION_TTL_SECONDS: ${DEVICE_SESSION_TTL_SECONDS:-900}
      # DEVICE_CHALLENGE_TTL_SECONDS: ${DEVICE_CHALLENGE_TTL_SECONDS:-60}
    volumes:
      # Mount keys directory for persistence (optional)
      - ./keys:/app/keys
      - ./user_keys:/app/user_keys
      - ./sensor_keys:/app/sensor_keys
      # Mount certs directory for TLS certificates (optional)
      - ./certs:/app/certs:ro
    # Health check (simple HTTP check)
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.settimeout(2); s.connect(('localhost', 5000)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Uncomment the line below if running Docker on the same server as MariaDB
    # and you want to use host network (Linux only)
    # network_mode: "host"
    # Alternative: Use extra_hosts to map host.docker.internal (if not available)
    extra_hosts:
      - "host.docker.internal:host-gateway"

